<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><style>
body,html{margin:0;padding:0;overflow:hidden;}
canvas{border:1px solid #ccc;display:block;margin:0 auto;}
</style></head><body>
<canvas id="c" width="800" height="600"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
// 圧縮前コード
(function(){
var c=new fabric.Canvas('c',{selection:false});
var panel=new fabric.Rect({left:200,top:150,width:400,height:300,fill:'lightblue',originX:'left',originY:'top',selectable:false});
c.add(panel);

var isDown=false,sx=0,sy=0,line;
c.on('mouse:down',function(o){
 var p=c.getPointer(o.e);isDown=true;sx=p.x;sy=p.y;line=new fabric.Line([sx,sy,sx,sy],{stroke:'red',strokeWidth:2,selectable:false,excludeFromExport:true});
 c.add(line);
});
c.on('mouse:move',function(o){
 if(!isDown)return;
 var p=c.getPointer(o.e);
 line.set({x2:p.x,y2:p.y});
 c.renderAll();
});
c.on('mouse:up',function(o){
 if(!isDown)return;
 isDown=false;
 // ライン確定
 var x1=line.x1,y1=line.y1,x2=line.x2,y2=line.y2;
//  c.remove(line);
 line=null;
 
 // パネルを分割
 // 1) パネルの四隅取得
 var px=panel.left,py=panel.top,pw=panel.width,ph=panel.height;
 var corners=[
  {x:px,y:py},
  {x:px+pw,y:py},
  {x:px+pw,y:py+ph},
  {x:px,y:py+ph}
 ];
 // 辺(4本)との交差判定
 function intersect(x1,y1,x2,y2,x3,y3,x4,y4){
   var denom=(y4 - y3)*(x2 - x1)-(x4 - x3)*(y2 - y1);
   if(Math.abs(denom)<1e-9)return null;
   var ua=((x4 - x3)*(y1 - y3)-(y4 - y3)*(x1 - x3))/denom;
   var ub=((x2 - x1)*(y1 - y3)-(y2 - y1)*(x1 - x3))/denom;
   if(ua>=0&&ua<=1&&ub>=0&&ub<=1){
     return {x:x1+ua*(x2 - x1),y:y1+ua*(y2 - y1)};
   }
   return null;
 }

 var interPoints=[];
 for(var i=0;i<4;i++){
   var c1=corners[i],c2=corners[(i+1)%4];
   var ip=intersect(x1,y1,x2,y2,c1.x,c1.y,c2.x,c2.y);
   if(ip) interPoints.push({x:ip.x,y:ip.y,edge:i});
 }
 if(interPoints.length<2){
   // ラインがパネルを貫通しなかった場合は何もしない
   return;
 }

 // パネルを多角形に分割(2つのポリゴン)する
 // パネルは長方形なので、交点は2つ
 var I1=interPoints[0],I2=interPoints[1];

 // 長方形を分割するには、ラインを境に上側と下側(もしくは左側と右側)に分ける
 // 元々の矩形 corners: [0:top-left,1:top-right,2:bottom-right,3:bottom-left]
 // ラインで分割する場合、切断線が多角形を2つの多角形に分ける
 // 多角形1と2を作成するには、元の四角形の順番に辺をトラバースし、切断点を挿入
 // ライン方向で多角形を分けるには、ラインの左側頂点群と右側頂点群で分ける。
 
 // 線(ax+by+c=0)を定義
 var dx=x2-x1,dy=y2-y1;
 var len=Math.sqrt(dx*dx+dy*dy);
 var nx=dy/len,ny=-dx/len; // 線に対して法線ベクトル(一方)
 // 線の方程式
 // 点(sx,sy)通過、方向(dx,dy)
 // 法線方向(nx,ny)を使い、ax+by+c=0として c=-(a*x0+b*y0)になる
 // a=nx,b=ny,c=-(nx*sx+ny*sy)
 var a=nx,b=ny,c=-(nx*sx+ny*sy);
 function sideOfLine(x,y){return a*x+b*y+c;}
 
 // 分割後の多角形を得るため、元の四角形の頂点を走査
 // 各頂点が線のどちら側にあるかで2つのセットに振り分け
 // 線上を2点で交差するので、それらを挿入して完了
 function buildPolygons(corners,I1,I2){
   // I1,I2は交点
   // 頂点を巡回し、ポリゴンを2つに分解
   var poly1=[],poly2=[];
   var insertDone=false;
   function addPointTo(poly,pt){poly.push({x:pt.x,y:pt.y});}
   
   for(var i=0;i<4;i++){
     var cur=corners[i],nxt=corners[(i+1)%4];
     var s=sideOfLine(cur.x,cur.y);
     var s2=sideOfLine(nxt.x,nxt.y);
     if(s>=0) addPointTo(poly1,cur);
     else addPointTo(poly2,cur);
     // 辺が交差点を含むか？
     var edgeInt=null;
     if(i===I1.edge||i===I2.edge){
       // この辺上にI1 or I2がある
       if(i===I1.edge) edgeInt=I1;
       if(i===I2.edge) edgeInt=(edgeInt)?[edgeInt,I2]:I2;
     }
     if(edgeInt){
       // I1,I2どちらかまたは両方挿入
       if(Array.isArray(edgeInt)){
         // 両方この辺上（実際は有りえないが万一）
         addPointTo(poly1,edgeInt[0]);
         addPointTo(poly2,edgeInt[0]);
         addPointTo(poly1,edgeInt[1]);
         addPointTo(poly2,edgeInt[1]);
       }else{
         addPointTo(poly1,edgeInt);
         addPointTo(poly2,edgeInt);
       }
     }
   }
   return [poly1,poly2];
 }

 var polys=buildPolygons(corners,I1,I2);

 // 2つの多角形をライン方向に20px分離
 // 法線方向に10pxずつずらす
 for(var i=0;i<polys.length;i++){
   var sign=(i===0)?1:-1;
   for(var j=0;j<polys[i].length;j++){
     polys[i][j].x+=nx*10*sign;
     polys[i][j].y+=ny*10*sign;
   }
 }

 // 古いパネルを削除
 c.remove(panel);

 // 新ポリゴンを追加
 function makePoly(points,color){
   return new fabric.Polygon(points,{fill:color,selectable:false});
 }
 var polyA=makePoly(polys[0],'lightblue');
 var polyB=makePoly(polys[1],'lightblue');
 c.add(polyA);
 c.add(polyB);
 c.renderAll();

});
// ここまで
})();

// 以下、コード圧縮(簡易minify)
</script>

</body></html>