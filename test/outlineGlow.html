<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        #c {
            border: 1px solid #000;
            background-color: black; /* 背景色を黒に設定 */
        }
        body {
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .controls {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <canvas id="c" width="800" height="600"></canvas>
    <div class="controls">
        <button id="addGlowButton">モヤを追加/削除</button>
        <br>
        <label for="blurSlider">モヤのレベル: </label>
        <input type="range" id="blurSlider" min="0" max="100" value="20">
        <span id="blurValue">20</span>
        <br>
        <label for="colorPicker">モヤの色: </label>
        <input type="color" id="colorPicker" value="#FFFFFF">
    </div>
    <script>
        const canvas = new fabric.Canvas('c');
        canvas.setBackgroundColor('black', canvas.renderAll.bind(canvas)); // 背景を黒に設定

        document.getElementById('addGlowButton').addEventListener('click', function() {
            console.log("Add Glow button clicked");
            const selectedObject = canvas.getActiveObject();
            if (selectedObject) {
                if (selectedObject.shadow) {
                    console.log("Removing glow from the selected object:", selectedObject);
                    selectedObject.set({ shadow: null });
                } else {
                    const color = document.getElementById('colorPicker').value;
                    const blurValue = parseInt(document.getElementById('blurSlider').value, 10);
                    console.log("Adding glow to the selected object:", selectedObject, "Color:", color, "Blur:", blurValue);
                    selectedObject.set({
                        shadow: {
                            color: color,
                            blur: blurValue,
                            offsetX: 0,
                            offsetY: 0
                        }
                    });
                }
                canvas.renderAll();
            } else {
                console.log("No object selected");
            }
        });

        document.getElementById('blurSlider').addEventListener('input', function() {
            const blurValue = parseInt(this.value, 10);
            document.getElementById('blurValue').innerText = blurValue;
            console.log("Blur slider value:", blurValue);

            const selectedObject = canvas.getActiveObject();
            if (selectedObject && selectedObject.shadow) {
                const color = document.getElementById('colorPicker').value;
                console.log("Updating shadow to color:", color, "Blur:", blurValue);
                selectedObject.shadow.color = color;
                selectedObject.shadow.blur = blurValue;
                canvas.renderAll();
            } else {
                console.log("No object selected or no shadow to update");
            }
        });

        document.getElementById('colorPicker').addEventListener('input', function() {
            const color = this.value;
            console.log("Color picker value:", color);

            const selectedObject = canvas.getActiveObject();
            if (selectedObject && selectedObject.shadow) {
                const blurValue = parseInt(document.getElementById('blurSlider').value, 10);
                console.log("Updating shadow to color:", color, "Blur:", blurValue);
                selectedObject.shadow.color = color;
                selectedObject.shadow.blur = blurValue;
                canvas.renderAll();
            } else {
                console.log("No object selected or no shadow to update");
            }
        });

        function handleDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            const reader = new FileReader();

            reader.onload = function(e) {
                const imgElement = new Image();
                imgElement.src = e.target.result;
                imgElement.onload = function() {
                    const imgInstance = new fabric.Image(imgElement, {
                        left: 100,
                        top: 100
                    });
                    canvas.add(imgInstance);
                    canvas.setActiveObject(imgInstance);
                    console.log("Image added to canvas:", imgInstance);
                }
            }

            if (files.length > 0) {
                reader.readAsDataURL(files[0]);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
        }

        document.body.addEventListener('drop', handleDrop);
        document.body.addEventListener('dragover', handleDragOver);
    </script>
</body>
</html>