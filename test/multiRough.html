<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>Fabric.jsとRough.jsの統合 (複雑な形状版)</title><script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/rough.js/3.1.0/rough.js"></script><style>.tooltip{position:absolute;background-color:#333;color:#fff;padding:5px;border-radius:5px;pointer-events:none;display:none}</style></head><body><button id="roughifyButton">ラフ化する</button><canvas id="c" width="800" height="600"></canvas><div id="tooltip" class="tooltip"></div><script>const canvas=new fabric.Canvas("c"),rect=new fabric.Rect({left:100,top:50,width:100,height:100,fill:"blue"}),circle=new fabric.Circle({left:300,top:50,radius:50,fill:"green"}),polygon=new fabric.Polygon([{x:500,y:50},{x:550,y:100},{x:500,y:150},{x:450,y:100}],{fill:"red"}),path=new fabric.Path("M 100 100 Q 200 200 300 100",{left:100,top:200,stroke:"black",strokeWidth:2}),cloud=new fabric.Path("M25,60 Q40,40 60,50 T95,50 T130,60 T160,70 T190,65 Q200,80 175,85 Q185,95 170,100 Q160,115 140,110 Q120,120 100,110 Q80,120 65,105 Q40,110 35,95 Q15,90 25,60",{left:400,top:100,fill:"lightblue",scaleX:1.5,scaleY:1.5}),complexPolygon=new fabric.Polygon([{x:50,y:0},{x:100,y:25},{x:150,y:0},{x:200,y:50},{x:175,y:100},{x:200,y:150},{x:150,y:200},{x:100,y:175},{x:50,y:200},{x:0,y:150},{x:25,y:100},{x:0,y:50}],{left:500,top:300,fill:"purple"}),curveAndLine=new fabric.Group([new fabric.Path("M0,0 Q50,-50 100,0 T200,0",{stroke:"orange",strokeWidth:3,fill:""}),new fabric.Line([0,0,200,0],{stroke:"red",strokeWidth:2})],{left:100,top:400}),complexGroup=new fabric.Group([new fabric.Circle({radius:30,fill:"yellow",left:0,top:0}),new fabric.Rect({width:60,height:60,fill:"green",left:60,top:0}),new fabric.Triangle({width:60,height:60,fill:"blue",left:120,top:0}),new fabric.Path("M0,60 Q30,120 60,60 T120,60",{fill:"red",left:0,top:60})],{left:400,top:400});async function roughifyObject(e){if(console.log("オブジェクトのラフ化を開始:",e.type,e.id?`(ID: ${e.id})`:""),"group"===e.type){console.log("グループを処理中:",e);const o=new fabric.Group([],{left:e.left,top:e.top,scaleX:e.scaleX,scaleY:e.scaleY,angle:e.angle,selectable:e.selectable});for(const t of e._objects){const e=await roughifyObject(t);e&&o.addWithUpdate(e)}return canvas.remove(e),canvas.add(o),canvas.requestRenderAll(),o}const o=e.getBoundingRect(),t=document.createElement("canvas");t.width=Math.max(Math.ceil(o.width),1),t.height=Math.max(Math.ceil(o.height),1);const l=rough.canvas(t);let n;if("rect"===e.type)n=l.rectangle(0,0,e.width,e.height,{fill:e.fill});else if("circle"===e.type)n=l.circle(e.radius,e.radius,2*e.radius,{fill:e.fill});else{if("polygon"!==e.type&&"path"!==e.type)return console.log("未対応のオブジェクトタイプ:",e.type),null;{let t;t="polygon"===e.type?e.points.map(((e,t)=>(0===t?"M":"L")+`${e.x-o.left},${e.y-o.top}`)).join(" ")+"Z":e.path.map((e=>"string"==typeof e[0]?[e[0],...e.slice(1).map(((e,t)=>t%2==0?e-o.left:e-o.top))]:e)).map((e=>e.join(" "))).join(" "),console.log("ラフ化用パスデータ:",t),n=l.path(t,{fill:e.fill,stroke:e.stroke,strokeWidth:e.strokeWidth})}}return console.log("Rough Canvas:",t),console.log("Bounding Rect:",o),new Promise(((l,n)=>{const c=new Image;c.src=t.toDataURL("image/png"),c.onload=function(){const t=new fabric.Image(c,{left:o.left,top:o.top,scaleX:1,scaleY:1,angle:e.angle,selectable:e.selectable});e.id&&t.set("id",e.id),console.log("ラフ化されたイメージがCanvasに追加されます:",e.type,e.id?`(ID: ${e.id})`:""),canvas.remove(e),canvas.add(t),canvas.requestRenderAll(),console.log("ラフ化されたイメージがCanvasに追加されました"),l(t)},c.onerror=function(e){console.log("ラフ化されたイメージの読み込みに失敗しました:",e),n(e)}}))}function addTooltip(e,o){e.on("mouseover",(function(){const e=document.getElementById("tooltip");e.style.display="block",e.innerHTML=o})),e.on("mousemove",(function(e){const o=document.getElementById("tooltip");o.style.left=e.e.clientX+"px",o.style.top=e.e.clientY+"px"})),e.on("mouseout",(function(){document.getElementById("tooltip").style.display="none"}))}canvas.add(rect,circle,polygon,path,cloud,complexPolygon,curveAndLine,complexGroup),addTooltip(rect,"Rectangle"),addTooltip(circle,"Circle"),addTooltip(polygon,"Polygon"),addTooltip(path,"Path"),addTooltip(cloud,"Cloud"),addTooltip(complexPolygon,"Complex Polygon"),addTooltip(curveAndLine,"Curve and Line"),addTooltip(complexGroup,"Complex Group"),document.getElementById("roughifyButton").addEventListener("click",(async function(){const e=canvas.getObjects().slice();for(const o of e)try{await roughifyObject(o)}catch(e){console.error("オブジェクトのラフ化中にエラーが発生しました:",e)}canvas.requestRenderAll()}))</script></body></html>