<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ブラー効果付き二重アウトラインブラシ描画</title><script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script><style>body{background-color:#1a1a1a;color:#fff;font-family:Arial,sans-serif}#canvas-container{width:100%;max-width:800px;margin:20px auto;border:1px solid #ccc}#controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:20px auto;max-width:800px}.control-group{background-color:#2a2a2a;padding:10px;border-radius:5px}.control-group h3{margin-top:0}label{display:block;margin-bottom:5px}input{width:100%;padding:5px;margin-bottom:10px}button{width:100%;padding:10px;background-color:#4caf50;color:#fff;border:none;border-radius:5px;cursor:pointer}button:hover{background-color:#45a049}</style></head><body><div id="canvas-container"><canvas id="canvas"></canvas></div><div id="controls"><div class="control-group"><h3>メインブラシ</h3><label for="brushColor">色:</label> <input type="color" id="brushColor" value="#FFFFFF"> <label for="brushWidth">幅:</label> <input type="number" id="brushWidth" value="20" min="1" max="50"></div><div class="control-group"><h3>アウトライン1</h3><label for="outline1Color">色:</label> <input type="color" id="outline1Color" value="#FF0000"> <label for="outline1Width">幅:</label> <input type="number" id="outline1Width" value="4" min="0" max="10"> <label for="outline1Opacity">不透明度:</label> <input type="range" id="outline1Opacity" value="100" min="0" max="100"> <span id="opacity1Value">100%</span></div><div class="control-group"><h3>アウトライン2</h3><label for="outline2Color">色:</label> <input type="color" id="outline2Color" value="#0000FF"> <label for="outline2Width">幅:</label> <input type="number" id="outline2Width" value="2" min="0" max="10"> <label for="outline2Opacity">不透明度:</label> <input type="range" id="outline2Opacity" value="100" min="0" max="100"> <span id="opacity2Value">100%</span></div><div class="control-group"><h3>ブラー1</h3><label for="blur1Color">色:</label> <input type="color" id="blur1Color" value="#FF00FF"> <label for="blur1Size">サイズ:</label> <input type="number" id="blur1Size" value="10" min="0" max="50"> <label for="blur1Strength">強度:</label> <input type="range" id="blur1Strength" value="50" min="0" max="100"> <span id="blur1StrengthValue">50%</span></div><div class="control-group"><h3>ブラー2</h3><label for="blur2Color">色:</label> <input type="color" id="blur2Color" value="#00FFFF"> <label for="blur2Size">サイズ:</label> <input type="number" id="blur2Size" value="5" min="0" max="50"> <label for="blur2Strength">強度:</label> <input type="range" id="blur2Strength" value="50" min="0" max="100"> <span id="blur2StrengthValue">50%</span></div><div class="control-group"><h3>操作</h3><button id="clear">クリア</button> <button id="toggleBrush">ブラシモード切替</button></div></div><script>let canvas,currentPath,isDrawing=!1,points=[];function initCanvas(){canvas=new fabric.Canvas("canvas",{isDrawingMode:!0,width:800,height:600,backgroundColor:"black"}),canvas.freeDrawingBrush=new fabric.SmoothDoubleOutlineBrush(canvas),updateBrush()}function updateBrush(){canvas&&canvas.freeDrawingBrush&&(canvas.freeDrawingBrush.color=document.getElementById("brushColor").value,canvas.freeDrawingBrush.width=parseInt(document.getElementById("brushWidth").value),canvas.freeDrawingBrush.outline1Color=document.getElementById("outline1Color").value,canvas.freeDrawingBrush.outline1Width=parseInt(document.getElementById("outline1Width").value),canvas.freeDrawingBrush.outline1Opacity=parseInt(document.getElementById("outline1Opacity").value)/100,canvas.freeDrawingBrush.outline2Color=document.getElementById("outline2Color").value,canvas.freeDrawingBrush.outline2Width=parseInt(document.getElementById("outline2Width").value),canvas.freeDrawingBrush.outline2Opacity=parseInt(document.getElementById("outline2Opacity").value)/100,canvas.freeDrawingBrush.blur1Color=document.getElementById("blur1Color").value,canvas.freeDrawingBrush.blur1Size=parseInt(document.getElementById("blur1Size").value),canvas.freeDrawingBrush.blur1Strength=parseInt(document.getElementById("blur1Strength").value)/100,canvas.freeDrawingBrush.blur2Color=document.getElementById("blur2Color").value,canvas.freeDrawingBrush.blur2Size=parseInt(document.getElementById("blur2Size").value),canvas.freeDrawingBrush.blur2Strength=parseInt(document.getElementById("blur2Strength").value)/100,document.getElementById("opacity1Value").textContent=`${document.getElementById("outline1Opacity").value}%`,document.getElementById("opacity2Value").textContent=`${document.getElementById("outline2Opacity").value}%`,document.getElementById("blur1StrengthValue").textContent=`${document.getElementById("blur1Strength").value}%`,document.getElementById("blur2StrengthValue").textContent=`${document.getElementById("blur2Strength").value}%`)}function clearCanvas(){canvas&&(canvas.clear(),canvas.freeDrawingBrush.outlineImage&&canvas.remove(canvas.freeDrawingBrush.outlineImage))}function toggleBrushMode(){canvas.isDrawingMode=!canvas.isDrawingMode,document.getElementById("toggleBrush").textContent=canvas.isDrawingMode?"ブラシモード終了":"ブラシモード開始",canvas.isDrawingMode||(isDrawing=!1,currentPath=null)}function initEventListeners(){["brushColor","outline1Color","outline2Color","brushWidth","outline1Width","outline2Width","outline1Opacity","outline2Opacity","blur1Color","blur2Color","blur1Size","blur2Size","blur1Strength","blur2Strength"].forEach((t=>{const e=document.getElementById(t);e.addEventListener("input",updateBrush),e.addEventListener("change",updateBrush)})),document.getElementById("clear").addEventListener("click",clearCanvas),document.getElementById("toggleBrush").addEventListener("click",toggleBrushMode)}fabric.SmoothDoubleOutlineBrush=fabric.util.createClass(fabric.PencilBrush,{type:"SmoothDoubleOutlineBrush",initialize:function(t){this.callSuper("initialize",t),this.color="#FFFFFF",this.width=20,this.outline1Color="#FF0000",this.outline1Width=4,this.outline1Opacity=1,this.outline2Color="#0000FF",this.outline2Width=2,this.outline2Opacity=1,this.blur1Color="#FF00FF",this.blur1Size=10,this.blur1Strength=.5,this.blur2Color="#00FFFF",this.blur2Size=5,this.blur2Strength=.5,this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=t.width,this.offscreenCanvas.height=t.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d")},onMouseDown:function(t,e){this.callSuper("onMouseDown",t,e),isDrawing=!0,points=[t],currentPath=new fabric.Path(`M ${t.x} ${t.y}`,{stroke:this.color,strokeWidth:this.width,fill:null,strokeLineCap:"round",strokeLineJoin:"round",outline1Color:this.outline1Color,outline1Width:this.outline1Width,outline1Opacity:this.outline1Opacity,outline2Color:this.outline2Color,outline2Width:this.outline2Width,outline2Opacity:this.outline2Opacity,blur1Color:this.blur1Color,blur1Size:this.blur1Size,blur1Strength:this.blur1Strength,blur2Color:this.blur2Color,blur2Size:this.blur2Size,blur2Strength:this.blur2Strength}),this.canvas.add(currentPath),this._renderCurrentPath()},onMouseMove:function(t,e){if(isDrawing){if(this.callSuper("onMouseMove",t,e),points.push(t),points.length>3){const t=points.length-1,e=(points[t].x+points[t-1].x)/2,n=(points[t].y+points[t-1].y)/2;currentPath.path.push(["Q",points[t-1].x,points[t-1].y,e,n]),points.shift()}this._renderCurrentPath()}},onMouseUp:function(t){if(isDrawing){if(this.callSuper("onMouseUp",t),isDrawing=!1,points.length>3){const t=points.length-1;currentPath.path.push(["L",points[t].x,points[t].y])}this._finalizeDrawing(),points=[]}},_renderCurrentPath:function(){this.canvas.renderAll(),this._processOutlinesAndBlur()},_finalizeDrawing:function(){this._processOutlinesAndBlur(),currentPath=null},_processOutlinesAndBlur:function(){this.offscreenCtx.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.canvas.getObjects("path").forEach((t=>{t.outline2Width>0&&this._drawPathToOffscreen(t,this.offscreenCtx,t.strokeWidth+2*t.outline1Width+2*t.outline2Width,t.outline2Color,t.outline2Opacity)})),this.blur2Size>0&&this._applyBlur(this.offscreenCtx,this.blur2Size,this.blur2Strength,this.blur2Color),this.canvas.getObjects("path").forEach((t=>{t.outline1Width>0&&this._drawPathToOffscreen(t,this.offscreenCtx,t.strokeWidth+2*t.outline1Width,t.outline1Color,t.outline1Opacity)})),this.blur1Size>0&&this._applyBlur(this.offscreenCtx,this.blur1Size,this.blur1Strength,this.blur1Color),this.canvas.getObjects("path").forEach((t=>{this._drawPathToOffscreen(t,this.offscreenCtx,t.strokeWidth,t.stroke,1)})),this.outlineImage&&this.canvas.remove(this.outlineImage),this.outlineImage=new fabric.Image(this.offscreenCanvas,{left:0,top:0,selectable:!1,evented:!1}),this.canvas.insertAt(this.outlineImage,0),this.canvas.renderAll()},_drawPathToOffscreen:function(t,e,n,i,r){e.save(),e.beginPath(),e.strokeStyle=i,e.globalAlpha=r,e.lineWidth=n,e.lineCap="round",e.lineJoin="round",t.path.forEach(((t,n)=>{"M"===t[0]?e.moveTo(t[1],t[2]):"L"===t[0]?e.lineTo(t[1],t[2]):"Q"===t[0]&&e.quadraticCurveTo(t[1],t[2],t[3],t[4])})),e.stroke(),e.restore()},_applyBlur:function(t,e,n,i){const r=document.createElement("canvas");r.width=this.offscreenCanvas.width,r.height=this.offscreenCanvas.height;const o=r.getContext("2d");o.drawImage(this.offscreenCanvas,0,0),o.filter=`blur(${e}px)`,o.globalAlpha=n,o.globalCompositeOperation="source-atop",o.fillStyle=i,o.fillRect(0,0,r.width,r.height),t.drawImage(r,0,0)}}),document.addEventListener("DOMContentLoaded",(function(){initCanvas(),initEventListeners()}))</script></body></html>