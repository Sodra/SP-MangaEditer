<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>二重アウトラインブラシ描画</title><script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script><style>#c{width:100%;max-width:800px;margin:0 auto;border:1px solid #ccc}#t{margin-top:20px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}.r{display:flex;gap:10px;align-items:center}.i{display:flex;align-items:center;gap:5px}.n{font-weight:700;white-space:nowrap}input[type=color]{width:50px;height:30px;padding:0;border:none}input[type=number],input[type=range]{width:60px}button{padding:5px 10px}</style></head><body><div id="c"><canvas id="v"></canvas></div><div id="t"><div class="r"><div class="i"><div class="n">ブラシ色：</div><input type="color" id="a" value="#000000"></div><div class="i"><div class="n">アウトライン1：</div><input type="color" id="b" value="#FFFFFF"></div><div class="i"><div class="n">アウトライン2：</div><input type="color" id="d" value="#000000"></div></div><div class="r"><div class="i"><div class="n">ブラシ幅：</div><input type="number" id="e" value="10" min="1" max="50"><span id="ve">10</span></div><div class="i"><div class="n">アウトライン1幅：</div><input type="number" id="f" value="2" min="0" max="10"><span id="vf">2</span></div><div class="i"><div class="n">アウトライン2幅：</div><input type="number" id="g" value="1" min="0" max="10"><span id="vg">1</span></div></div><div class="r"><div class="i"><div class="n">アウトライン1不透明度：</div><input type="range" id="h" value="100" min="0" max="100"><span id="vh">100%</span></div><div class="i"><div class="n">アウトライン2不透明度：</div><input type="range" id="j" value="100" min="0" max="100"><span id="vj">100%</span></div></div><div class="r"><div class="i"><button id="n">クリア</button></div><div class="i"><button id="o">ブラシモード切替</button><span id="vo">オン</span></div></div></div><script>fabric.DoubleOutlineBrush=fabric.util.createClass(fabric.PencilBrush,{type:"DoubleOutlineBrush",initialize:function(e){this.callSuper("initialize",e),this.color="#000000",this.width=10,this.outline1Color="#FFFFFF",this.outline1Width=2,this.outline1Opacity=1,this.outline2Color="#000000",this.outline2Width=1,this.outline2Opacity=1,this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=e.width,this.offscreenCanvas.height=e.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d")},onMouseDown:function(t,n){this.callSuper("onMouseDown",t,n),d=!0,e=[t],f=new fabric.Path(`M ${t.x} ${t.y} L ${t.x} ${t.y}`,{stroke:this.color,strokeWidth:this.width,fill:null,strokeLineCap:"round",strokeLineJoin:"round",outline1Color:this.outline1Color,outline1Width:this.outline1Width,outline1Opacity:this.outline1Opacity,outline2Color:this.outline2Color,outline2Width:this.outline2Width,outline2Opacity:this.outline2Opacity}),this.canvas.add(f),this._renderCurrentPath()},onMouseMove:function(t,n){if(d){if(this.callSuper("onMouseMove",t,n),e.push(t),3<e.length){const t=e.length-1,n=(e[t].x+e[t-1].x)/2,i=(e[t].y+e[t-1].y)/2;f.path.push(["Q",e[t-1].x,e[t-1].y,n,i]),e.shift()}else f.path[1]=["L",t.x,t.y];this._renderCurrentPath()}},onMouseUp:function(t){d&&(this.callSuper("onMouseUp",t),d=!1,this._finalizeDrawing(),e=[])},_renderCurrentPath:function(){this.canvas.renderAll(),this._processOutlines()},_finalizeDrawing:function(){this._processOutlines(),f=null},_processOutlines:function(){this.offscreenCtx.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.canvas.getObjects("path").forEach((e=>{0<e.outline1Width&&0<e.outline2Width&&this._drawPathToOffscreen(e,this.offscreenCtx,e.strokeWidth+2*e.outline1Width+2*e.outline2Width,e.outline2Color,e.outline2Opacity)})),this.canvas.getObjects("path").forEach((e=>{0<e.outline1Width&&this._drawPathToOffscreen(e,this.offscreenCtx,e.strokeWidth+2*e.outline1Width,e.outline1Color,e.outline1Opacity)})),this.canvas.getObjects("path").forEach((e=>{this._drawPathToOffscreen(e,this.offscreenCtx,e.strokeWidth,e.stroke,1)})),this.outlineImage&&this.canvas.remove(this.outlineImage),this.outlineImage=new fabric.Image(this.offscreenCanvas,{left:0,top:0,selectable:!1,evented:!1}),this.canvas.insertAt(this.outlineImage,0),this.canvas.renderAll()},_drawPathToOffscreen:function(e,t,n,i,o){t.save(),t.beginPath(),t.strokeStyle=i,t.globalAlpha=o,t.lineWidth=n,t.lineCap="round",t.lineJoin="round",e.path.forEach(((e,n)=>{"M"===e[0]?t.moveTo(e[1],e[2]):"L"===e[0]?t.lineTo(e[1],e[2]):"Q"===e[0]&&t.quadraticCurveTo(e[1],e[2],e[3],e[4])})),1===e.path.length&&t.lineTo(e.path[0][1],e.path[0][2]),t.stroke(),t.restore()}});let c,f,d=!1,e=[];function g(){c=new fabric.Canvas("v",{isDrawingMode:!0,width:800,height:600}),c.freeDrawingBrush=new fabric.DoubleOutlineBrush(c),h()}function h(){if(c&&c.freeDrawingBrush){const e=c.freeDrawingBrush;e.color=document.getElementById("a").value,e.width=parseInt(document.getElementById("e").value),e.outline1Color=document.getElementById("b").value,e.outline1Width=parseInt(document.getElementById("f").value),e.outline1Opacity=parseInt(document.getElementById("h").value)/100,e.outline2Color=document.getElementById("d").value,e.outline2Width=parseInt(document.getElementById("g").value),e.outline2Opacity=parseInt(document.getElementById("j").value)/100,["e","f","g","h","j"].forEach((e=>{document.getElementById("v"+e).textContent=document.getElementById(e).value+(["h","j"].includes(e)?"%":"")}))}}function i(){c&&(c.clear(),c.freeDrawingBrush.outlineImage&&c.remove(c.freeDrawingBrush.outlineImage))}function j(){c.isDrawingMode=!c.isDrawingMode,document.getElementById("vo").textContent=c.isDrawingMode?"オン":"オフ",c.isDrawingMode?(c.selection=!1,c.forEachObject((function(e){e.selectable=!1})),h()):(d=!1,f=null,c.selection=!0,c.forEachObject((function(e){e.selectable=!0}))),c.renderAll()}function k(){["a","b","d","e","f","g","h","j"].forEach((e=>{const t=document.getElementById(e);t.addEventListener("input",h),t.addEventListener("change",h)})),document.getElementById("n").addEventListener("click",i),document.getElementById("o").addEventListener("click",j)}document.addEventListener("DOMContentLoaded",(function(){k(),g()}))</script></body></html>