<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ファー効果付き二重アウトラインブラシ描画</title><script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script><style>#canvas-container{width:100%;max-width:800px;margin:0 auto;border:1px solid #ccc}#controls{margin-top:20px;text-align:center}button,input{margin:0 5px;padding:5px 10px}</style></head><body><div id="canvas-container"><canvas id="canvas"></canvas></div><div id="controls"><input type="color" id="brushColor" value="#000000"> <input type="color" id="outline1Color" value="#FFFFFF"> <input type="color" id="outline2Color" value="#000000"> <input type="number" id="brushWidth" value="20" min="1" max="50"> <input type="number" id="outline1Width" value="4" min="0" max="10"> <input type="number" id="outline2Width" value="2" min="0" max="10"> <input type="range" id="outline1Opacity" value="100" min="0" max="100"> <span id="opacity1Value">100%</span> <input type="range" id="outline2Opacity" value="100" min="0" max="100"> <span id="opacity2Value">100%</span> <input type="number" id="furLength" value="10" min="1" max="50"> <input type="number" id="furDensity" value="5" min="1" max="20"> <button id="clear">クリア</button> <button id="toggleBrush">ブラシモード切替</button></div><script>let canvas,currentPath,isDrawing=!1,points=[];function initCanvas(){canvas=new fabric.Canvas("canvas",{isDrawingMode:!0,width:800,height:600}),canvas.freeDrawingBrush=new fabric.FurDoubleOutlineBrush(canvas),updateBrush()}function updateBrush(){canvas&&canvas.freeDrawingBrush&&(canvas.freeDrawingBrush.color=document.getElementById("brushColor").value,canvas.freeDrawingBrush.width=parseInt(document.getElementById("brushWidth").value),canvas.freeDrawingBrush.outline1Color=document.getElementById("outline1Color").value,canvas.freeDrawingBrush.outline1Width=parseInt(document.getElementById("outline1Width").value),canvas.freeDrawingBrush.outline1Opacity=parseInt(document.getElementById("outline1Opacity").value)/100,canvas.freeDrawingBrush.outline2Color=document.getElementById("outline2Color").value,canvas.freeDrawingBrush.outline2Width=parseInt(document.getElementById("outline2Width").value),canvas.freeDrawingBrush.outline2Opacity=parseInt(document.getElementById("outline2Opacity").value)/100,canvas.freeDrawingBrush.furLength=parseInt(document.getElementById("furLength").value),canvas.freeDrawingBrush.furDensity=parseInt(document.getElementById("furDensity").value),document.getElementById("opacity1Value").textContent=`${document.getElementById("outline1Opacity").value}%`,document.getElementById("opacity2Value").textContent=`${document.getElementById("outline2Opacity").value}%`)}function clearCanvas(){canvas&&(canvas.clear(),canvas.freeDrawingBrush.outlineImage&&canvas.remove(canvas.freeDrawingBrush.outlineImage))}function toggleBrushMode(){canvas.isDrawingMode=!canvas.isDrawingMode,document.getElementById("toggleBrush").textContent=canvas.isDrawingMode?"ブラシモード終了":"ブラシモード開始",canvas.isDrawingMode?(canvas.selection=!1,canvas.forEachObject((function(t){t.selectable=!1})),updateBrush()):(isDrawing=!1,currentPath=null,canvas.selection=!0,canvas.forEachObject((function(t){t.selectable=!0}))),canvas.renderAll()}function initEventListeners(){["brushColor","outline1Color","outline2Color","brushWidth","outline1Width","outline2Width","outline1Opacity","outline2Opacity","furLength","furDensity"].forEach((t=>{const e=document.getElementById(t);e.addEventListener("input",updateBrush),e.addEventListener("change",updateBrush)})),document.getElementById("clear").addEventListener("click",clearCanvas),document.getElementById("toggleBrush").addEventListener("click",toggleBrushMode)}fabric.FurDoubleOutlineBrush=fabric.util.createClass(fabric.PencilBrush,{type:"FurDoubleOutlineBrush",initialize:function(t){this.callSuper("initialize",t),this.color="#000000",this.width=20,this.outline1Color="#FFFFFF",this.outline1Width=4,this.outline1Opacity=1,this.outline2Color="#000000",this.outline2Width=2,this.outline2Opacity=1,this.furLength=10,this.furDensity=5,this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=t.width,this.offscreenCanvas.height=t.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d")},onMouseDown:function(t,e){this.callSuper("onMouseDown",t,e),isDrawing=!0,points=[t],currentPath=new fabric.Path(`M ${t.x} ${t.y}`,{stroke:this.color,strokeWidth:this.width,fill:null,strokeLineCap:"round",strokeLineJoin:"round",outline1Color:this.outline1Color,outline1Width:this.outline1Width,outline1Opacity:this.outline1Opacity,outline2Color:this.outline2Color,outline2Width:this.outline2Width,outline2Opacity:this.outline2Opacity}),this.canvas.add(currentPath),this._renderCurrentPath()},onMouseMove:function(t,e){if(isDrawing){if(this.callSuper("onMouseMove",t,e),points.push(t),points.length>3){const t=points.length-1,e=(points[t].x+points[t-1].x)/2,n=(points[t].y+points[t-1].y)/2;currentPath.path.push(["Q",points[t-1].x,points[t-1].y,e,n]),points.shift()}this._renderCurrentPath()}},onMouseUp:function(t){if(isDrawing){if(this.callSuper("onMouseUp",t),isDrawing=!1,points.length>3){const t=points.length-1;currentPath.path.push(["L",points[t].x,points[t].y])}this._finalizeDrawing(),points=[]}},_renderCurrentPath:function(){this.canvas.renderAll(),this._processOutlinesAndFur()},_finalizeDrawing:function(){this._processOutlinesAndFur(),currentPath=null},_processOutlinesAndFur:function(){this.offscreenCtx.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.canvas.getObjects("path").forEach((t=>{t.outline1Width>0&&t.outline2Width>0&&(this._drawPathToOffscreen(t,this.offscreenCtx,t.strokeWidth+2*t.outline1Width+2*t.outline2Width,t.outline2Color,t.outline2Opacity),this._drawFur(t,this.offscreenCtx,t.strokeWidth+2*t.outline1Width+2*t.outline2Width,t.outline2Color,t.outline2Opacity))})),this.canvas.getObjects("path").forEach((t=>{t.outline1Width>0&&(this._drawPathToOffscreen(t,this.offscreenCtx,t.strokeWidth+2*t.outline1Width,t.outline1Color,t.outline1Opacity),this._drawFur(t,this.offscreenCtx,t.strokeWidth+2*t.outline1Width,t.outline1Color,t.outline1Opacity))})),this.canvas.getObjects("path").forEach((t=>{this._drawPathToOffscreen(t,this.offscreenCtx,t.strokeWidth,t.stroke,1),this._drawFur(t,this.offscreenCtx,t.strokeWidth,t.stroke,1)})),this.outlineImage&&this.canvas.remove(this.outlineImage),this.outlineImage=new fabric.Image(this.offscreenCanvas,{left:0,top:0,selectable:!1,evented:!1}),this.canvas.insertAt(this.outlineImage,0),this.canvas.renderAll()},_drawPathToOffscreen:function(t,e,n,i,a){e.save(),e.beginPath(),e.strokeStyle=i,e.globalAlpha=a,e.lineWidth=n,e.lineCap="round",e.lineJoin="round",t.path.forEach(((t,n)=>{"M"===t[0]?e.moveTo(t[1],t[2]):"L"===t[0]?e.lineTo(t[1],t[2]):"Q"===t[0]&&e.quadraticCurveTo(t[1],t[2],t[3],t[4])})),e.stroke(),e.restore()},_drawFur:function(t,e,n,i,a){e.save(),e.strokeStyle=i,e.globalAlpha=a,e.lineWidth=1,e.lineCap="round";const o=this.furLength,s=this.furDensity;for(let n=1;n<t.path.length;n++){let i,a,r;"L"===t.path[n][0]?(i={x:t.path[n-1][1],y:t.path[n-1][2]},a={x:t.path[n][1],y:t.path[n][2]}):"Q"===t.path[n][0]&&(i={x:t.path[n-1][1],y:t.path[n-1][2]},r={x:t.path[n][1],y:t.path[n][2]},a={x:t.path[n][3],y:t.path[n][4]});const u=Math.sqrt(Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)),h=Math.floor(u/s);for(let s=0;s<h;s++){let l,c,d=s/h;if("L"===t.path[n][0])l={x:i.x+(a.x-i.x)*d,y:i.y+(a.y-i.y)*d},c={x:-(a.y-i.y)/u,y:(a.x-i.x)/u};else if("Q"===t.path[n][0]){l=this._getQuadraticPoint(i,r,a,d);let t=this._getQuadraticTangent(i,r,a,d);c={x:-t.y,y:t.x}}let f={x:l.x+c.x*o*Math.random(),y:l.y+c.y*o*Math.random()};e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(f.x,f.y),e.stroke()}}e.restore()},_getQuadraticPoint:function(t,e,n,i){return{x:Math.pow(1-i,2)*t.x+2*(1-i)*i*e.x+Math.pow(i,2)*n.x,y:Math.pow(1-i,2)*t.y+2*(1-i)*i*e.y+Math.pow(i,2)*n.y}},_getQuadraticTangent:function(t,e,n,i){let a=2*(1-i)*(e.x-t.x)+2*i*(n.x-e.x),o=2*(1-i)*(e.y-t.y)+2*i*(n.y-e.y),s=Math.sqrt(a*a+o*o);return{x:a/s,y:o/s}}}),document.addEventListener("DOMContentLoaded",(function(){initCanvas(),initEventListeners()}))</script></body></html>