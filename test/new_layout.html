<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric.js Resize</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        canvas {
            border: 1px solid #000;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <script>
        console.log('スクリプト開始');

        const canvas = new fabric.Canvas('canvas');
        console.log('Canvasオブジェクト作成:', canvas);

        const initialWidth = 800;
        const initialHeight = 600;
        const aspectRatio = initialWidth / initialHeight;

        canvas.setWidth(initialWidth);
        console.log('初期Canvas幅設定:', canvas.getWidth());

        canvas.setHeight(initialHeight);
        console.log('初期Canvas高さ設定:', canvas.getHeight());

        // 初期オブジェクトを追加
        const rect = new fabric.Rect({
            left: 100,
            top: 100,
            fill: 'red',
            width: 100,
            height: 100,
            stroke: 'black',
            strokeWidth: 5,
        });
        console.log('Rectオブジェクト作成:', rect);

        canvas.add(rect);
        console.log('RectオブジェクトをCanvasに追加');

        const initialCanvasWidth = canvas.getWidth();
        console.log('初期Canvas幅:', initialCanvasWidth);

        const initialCanvasHeight = canvas.getHeight();
        console.log('初期Canvas高さ:', initialCanvasHeight);

        // オブジェクトの初期状態を保存
        canvas.getObjects().forEach((obj) => {
            obj.initial = {
                left: obj.left,
                top: obj.top,
                scaleX: obj.scaleX,
                scaleY: obj.scaleY,
                strokeWidth: obj.strokeWidth
            };
        });

        // キャンバスのリサイズとオブジェクトのスケーリング
        function resizeCanvas(newWidth, newHeight) {
            console.log('resizeCanvas呼び出し, newWidth:', newWidth, 'newHeight:', newHeight);

            const scaleX = newWidth / initialCanvasWidth;
            const scaleY = newHeight / initialCanvasHeight;
            console.log('スケール計算, scaleX:', scaleX, 'scaleY:', scaleY);

            canvas.setDimensions({ width: newWidth, height: newHeight });
            console.log('Canvasの新しい寸法設定:', canvas.getWidth(), canvas.getHeight());

            canvas.getObjects().forEach((obj) => {
                console.log('オブジェクト処理開始:', obj);

                const newScaleX = obj.initial.scaleX * scaleX;
                const newScaleY = obj.initial.scaleY * scaleY;
                const newLeft = obj.initial.left * scaleX;
                const newTop = obj.initial.top * scaleY;
                const newStrokeWidth = obj.initial.strokeWidth * scaleX;

                console.log('オブジェクトの新しいスケール設定, newScaleX:', newScaleX, 'newScaleY:', newScaleY);
                console.log('オブジェクトの新しい位置設定, newLeft:', newLeft, 'newTop:', newTop);
                console.log('オブジェクトの新しいストローク幅設定, newStrokeWidth:', newStrokeWidth);

                obj.set({
                    scaleX: newScaleX,
                    scaleY: newScaleY,
                    left: newLeft,
                    top: newTop,
                    strokeWidth: newStrokeWidth
                });

                obj.setCoords();
                console.log('オブジェクトの設定更新完了:', obj);
            });

            canvas.renderAll();
            console.log('Canvasの再描画完了');
        }

        // ウィンドウサイズに合わせてキャンバスサイズを変更
        function adjustCanvasSize() {
            const windowWidth = window.innerWidth * 0.8; // ウィンドウ幅の80%
            const windowHeight = window.innerHeight * 0.8; // ウィンドウ高さの80%
            const windowAspectRatio = windowWidth / windowHeight;

            let newWidth, newHeight;
            if (windowAspectRatio > aspectRatio) {
                newHeight = windowHeight;
                newWidth = windowHeight * aspectRatio;
            } else {
                newWidth = windowWidth;
                newHeight = windowWidth / aspectRatio;
            }

            console.log('新しいCanvasサイズ計算, newWidth:', newWidth, 'newHeight:', newHeight);
            resizeCanvas(newWidth, newHeight);
        }

        // 初回のキャンバスサイズ変更
        adjustCanvasSize();
        console.log('初回のキャンバスサイズ変更完了');

        // ウィンドウのリサイズに対応
        window.addEventListener('resize', () => {
            console.log('ウィンドウリサイズイベント発生');
            adjustCanvasSize();
            console.log('リサイズ後のキャンバスサイズ変更完了');
        });

        console.log('スクリプト終了');
    </script>
</body>
</html>
