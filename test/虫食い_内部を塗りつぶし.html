<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>エッジ検出と三角形内部塗りつぶし</title><style>.control-panel{margin-top:10px}.control-item{margin-bottom:10px}.value-display{display:inline-block;width:40px;text-align:right}</style></head><body><input type="file" id="imageInput" accept="image/*"><canvas id="canvas"></canvas><div class="control-panel"><div class="control-item"><label for="widthSlider">三角形の最大幅 (ピクセル):</label> <input type="range" id="widthSlider" min="1" max="50" value="20" step="1"> <span id="widthValue" class="value-display">20</span></div><div class="control-item"><label for="probabilitySlider">適用確率 (%):</label> <input type="range" id="probabilitySlider" min="0" max="100" value="50" step="1"> <span id="probabilityValue" class="value-display">50</span></div><div class="control-item"><label for="colorPicker">色選択:</label> <input type="color" id="colorPicker" value="#FFC0CB"></div><div class="control-item"><label for="transparencyCheck">透明化:</label> <input type="checkbox" id="transparencyCheck"></div></div><script>const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),imageInput=document.getElementById("imageInput"),widthSlider=document.getElementById("widthSlider"),widthValue=document.getElementById("widthValue"),probabilitySlider=document.getElementById("probabilitySlider"),probabilityValue=document.getElementById("probabilityValue"),colorPicker=document.getElementById("colorPicker"),transparencyCheck=document.getElementById("transparencyCheck");let originalImageData;function handleImage(t){const e=new FileReader;e.onload=function(t){const e=new Image;e.onload=function(){canvas.width=e.width,canvas.height=e.height,ctx.drawImage(e,0,0),originalImageData=ctx.getImageData(0,0,canvas.width,canvas.height),processImage()},e.src=t.target.result},e.readAsDataURL(t.target.files[0])}function handleControlChange(){widthValue.textContent=widthSlider.value,probabilityValue.textContent=probabilitySlider.value,originalImageData&&processImage()}function processImage(){const t=new ImageData(new Uint8ClampedArray(originalImageData.data),originalImageData.width,originalImageData.height),e=t.data,a=t.width,n=t.height,i=new Uint8ClampedArray(a*n),r=new Float32Array(a*n);for(let t=1;t<n-1;t++)for(let n=1;n<a-1;n++){const l=4*(t*a+n),o=-e[l-4-4*a]+e[l+4-4*a]+-2*e[l-4]+2*e[l+4]+-e[l-4+4*a]+e[l+4+4*a],d=-e[l-4*a-4]-2*e[l-4*a]-e[l-4*a+4]+e[l+4*a-4]+2*e[l+4*a]+e[l+4*a+4],c=Math.sqrt(o*o+d*d);i[t*a+n]=c>100?255:0,r[t*a+n]=Math.atan2(d,o)}const l=parseInt(widthSlider.value),o=parseInt(probabilitySlider.value)/100,d=hexToRgb(colorPicker.value),c=transparencyCheck.checked;for(let t=0;t<n;t++)for(let h=0;h<a;h++)if(255===i[t*a+h]&&Math.random()<o){const o=r[t*a+h],g=o+Math.PI/2,s=Math.random()*l+1,m=Math.random()*l+l,u=h,I=t,p=h+Math.cos(g)*s/2,f=t+Math.sin(g)*s/2,M=h-Math.cos(g)*s/2,y=t-Math.sin(g)*s/2,b=h+Math.cos(o)*m,w=t+Math.sin(o)*m;fillTriangle(u,I,p,f,b,w,e,a,n,d,c,i),fillTriangle(u,I,M,y,b,w,e,a,n,d,c,i)}ctx.putImageData(t,0,0)}function fillTriangle(t,e,a,n,i,r,l,o,d,c,h,g){const s=Math.max(0,Math.floor(Math.min(t,a,i))),m=Math.min(o-1,Math.ceil(Math.max(t,a,i))),u=Math.max(0,Math.floor(Math.min(e,n,r))),I=Math.min(d-1,Math.ceil(Math.max(e,n,r)));for(let d=u;d<=I;d++)for(let u=s;u<=m;u++)if(255!==g[d*o+u]&&isPointInTriangle(u,d,t,e,a,n,i,r)){const t=4*(d*o+u);h?l[t+3]=0:(l[t]=c.r,l[t+1]=c.g,l[t+2]=c.b)}}function isPointInTriangle(t,e,a,n,i,r,l,o){const d=((r-o)*(t-l)+(l-i)*(e-o))/((r-o)*(a-l)+(l-i)*(n-o)),c=((o-n)*(t-l)+(a-l)*(e-o))/((r-o)*(a-l)+(l-i)*(n-o)),h=1-d-c;return 0<=d&&d<=1&&0<=c&&c<=1&&0<=h&&h<=1}function hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}imageInput.addEventListener("change",handleImage),widthSlider.addEventListener("input",handleControlChange),probabilitySlider.addEventListener("input",handleControlChange),colorPicker.addEventListener("input",handleControlChange),transparencyCheck.addEventListener("change",handleControlChange)</script></body></html>