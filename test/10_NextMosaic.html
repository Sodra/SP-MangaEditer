<!DOCTYPE html><html><head><meta charset="utf-8"><title>Fabric.js Canvas</title><script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script><style>#canvas-container{border:1px solid #ccc;margin:10px}#controls{margin:10px}.slider-container{margin:10px 0}</style></head><body><div id="controls"><button id="toggle-mosaic-brush">Toggle Mosaic Brush</button> <button id="toggle-flatten-brush">Toggle Flatten Brush</button> <input type="file" id="image-loader" name="image-loader"><div class="slider-container"><label for="mosaic-size">Mosaic Size: <span id="mosaic-size-value">20</span></label> <input type="range" id="mosaic-size" min="5" max="100" value="20"></div><div class="slider-container"><label for="circle-size">Circle Size: <span id="circle-size-value">20</span></label> <input type="range" id="circle-size" min="5" max="100" value="20"></div></div><div id="canvas-container"><canvas id="c" width="800" height="600"></canvas></div><script>var canvas=new fabric.Canvas("c");canvas.setBackgroundColor("black",canvas.renderAll.bind(canvas)),fabric.MosaicBrush=fabric.util.createClass(fabric.BaseBrush,{initialize:function(e){this.canvas=e,this.mosaicSize=20,this.circleSize=20,this.ctx=this.canvas.contextTop,this.lastX=null,this.lastY=null},onMouseDown:function(e){this.points=[e],this.drawMosaic(e),this.updateLastPointer(e)},onMouseMove:function(e){this.points.push(e),this.shouldDrawMosaic(e)&&(this.drawMosaic(e),this.updateLastPointer(e)),this.drawCircle(e)},onMouseUp:function(){this.points=[]},shouldDrawMosaic:function(e){if(null===this.lastX||null===this.lastY)return!0;var a=Math.abs(e.x-this.lastX),i=Math.abs(e.y-this.lastY);return a>=this.mosaicSize||i>=this.mosaicSize},updateLastPointer:function(e){this.lastX=e.x,this.lastY=e.y},drawMosaic:function(e){for(var a=this.canvas.getContext("2d",{willReadFrequently:!0}),i=this.mosaicSize,t=this.circleSize/2,s=e.x-t,n=e.y-t,r=0;r<this.circleSize;r+=Math.min(i,this.circleSize/2))for(var c=0;c<this.circleSize;c+=Math.min(i,this.circleSize/2)){var o=s+r,h=n+c;if(this.isInsideCircle(e.x,e.y,o,h,t)){for(var l=a.getImageData(o,h,i,i).data,u=0,v=0,f=0,d=0,g=0,B=0;B<l.length;B+=4)u+=l[B],v+=l[B+1],f+=l[B+2],d+=l[B+3],g++;u=Math.floor(u/g),v=Math.floor(v/g),f=Math.floor(f/g),d=Math.floor(d/g),a.fillStyle=`rgba(${u},${v},${f},${d/255})`,a.fillRect(o,h,i,i)}}},isInsideCircle:function(e,a,i,t,s){var n=e-i,r=a-t;return n*n+r*r<=s*s},drawCircle:function(e){var a=this.canvas.contextTop;a.clearRect(0,0,this.canvas.width,this.canvas.height),a.beginPath(),a.arc(e.x,e.y,this.circleSize/2,0,2*Math.PI),a.strokeStyle="rgba(0, 255, 0, 0.5)",a.lineWidth=2,a.stroke(),a.closePath()},clearCircle:function(){this.canvas.contextTop.clearRect(0,0,this.canvas.width,this.canvas.height)}}),fabric.FlattenBrush=fabric.util.createClass(fabric.BaseBrush,{initialize:function(e){this.canvas=e,this.mosaicSize=20,this.circleSize=20,this.ctx=this.canvas.contextTop},onMouseDown:function(e){this.points=[e],this.drawMosaic(e)},onMouseMove:function(e){this.points.push(e),this.drawMosaic(e),this.drawCircle(e)},onMouseUp:function(){this.points=[]},drawMosaic:function(e){for(var a=this.canvas.getContext("2d",{willReadFrequently:!0}),i=this.mosaicSize,t=this.circleSize/2,s=e.x-t,n=e.y-t,r=0;r<this.circleSize;r+=Math.min(i,this.circleSize/2))for(var c=0;c<this.circleSize;c+=Math.min(i,this.circleSize/2)){var o=s+r,h=n+c;if(this.isInsideCircle(e.x,e.y,o,h,t)){for(var l=a.getImageData(o,h,i,i).data,u=0,v=0,f=0,d=0,g=0,B=0;B<l.length;B+=4)u+=l[B],v+=l[B+1],f+=l[B+2],d+=l[B+3],g++;u=Math.floor(u/g),v=Math.floor(v/g),f=Math.floor(f/g),d=Math.floor(d/g),a.fillStyle=`rgba(${u},${v},${f},${d/255})`,a.fillRect(o,h,i,i)}}},isInsideCircle:function(e,a,i,t,s){var n=e-i,r=a-t;return n*n+r*r<=s*s},drawCircle:function(e){var a=this.canvas.contextTop;a.clearRect(0,0,this.canvas.width,this.canvas.height),a.beginPath(),a.arc(e.x,e.y,this.circleSize/2,0,2*Math.PI),a.strokeStyle="rgba(0, 255, 0, 0.5)",a.lineWidth=2,a.stroke(),a.closePath()},clearCircle:function(){this.canvas.contextTop.clearRect(0,0,this.canvas.width,this.canvas.height)}});var circleTimeout,mosaicBrush=new fabric.MosaicBrush(canvas),flattenBrush=new fabric.FlattenBrush(canvas),isMosaicBrushActive=!1,isFlattenBrushActive=!1;document.getElementById("toggle-mosaic-brush").addEventListener("click",(function(){isMosaicBrushActive?(canvas.isDrawingMode=!1,canvas.freeDrawingBrush=null,this.textContent="Enable Mosaic Brush"):(canvas.isDrawingMode=!0,canvas.freeDrawingBrush=mosaicBrush,canvas.freeDrawingBrush.mosaicSize=parseInt(document.getElementById("mosaic-size").value),canvas.freeDrawingBrush.circleSize=parseInt(document.getElementById("circle-size").value),this.textContent="Disable Mosaic Brush"),isMosaicBrushActive=!isMosaicBrushActive,isFlattenBrushActive=!1,document.getElementById("toggle-flatten-brush").textContent="Enable Flatten Brush"})),document.getElementById("toggle-flatten-brush").addEventListener("click",(function(){isFlattenBrushActive?(canvas.isDrawingMode=!1,canvas.freeDrawingBrush=null,this.textContent="Enable Flatten Brush"):(canvas.isDrawingMode=!0,canvas.freeDrawingBrush=flattenBrush,canvas.freeDrawingBrush.mosaicSize=parseInt(document.getElementById("mosaic-size").value),canvas.freeDrawingBrush.circleSize=parseInt(document.getElementById("circle-size").value),this.textContent="Disable Flatten Brush"),isFlattenBrushActive=!isFlattenBrushActive,isMosaicBrushActive=!1,document.getElementById("toggle-mosaic-brush").textContent="Enable Mosaic Brush"})),document.getElementById("mosaic-size").addEventListener("input",(function(){var e=this.value;document.getElementById("mosaic-size-value").textContent=e,isMosaicBrushActive&&(canvas.freeDrawingBrush.mosaicSize=parseInt(e)),isFlattenBrushActive&&(canvas.freeDrawingBrush.mosaicSize=parseInt(e))})),document.getElementById("circle-size").addEventListener("input",(function(){var e=this.value;if(document.getElementById("circle-size-value").textContent=e,isMosaicBrushActive&&(canvas.freeDrawingBrush.circleSize=parseInt(e)),isFlattenBrushActive&&(canvas.freeDrawingBrush.circleSize=parseInt(e)),canvas.freeDrawingBrush&&canvas.freeDrawingBrush.drawCircle){var a={x:canvas.width/2,y:canvas.height/2};canvas.freeDrawingBrush&&canvas.freeDrawingBrush.drawCircle&&canvas.freeDrawingBrush.drawCircle(a),clearTimeout(circleTimeout),circleTimeout=setTimeout((function(){canvas.freeDrawingBrush&&canvas.freeDrawingBrush.clearCircle&&canvas.freeDrawingBrush.clearCircle()}),1e3)}})),canvas.on("mouse:move",(function(e){if(isMosaicBrushActive||isFlattenBrushActive){var a=canvas.getPointer(e.e);canvas.freeDrawingBrush&&canvas.freeDrawingBrush.drawCircle&&canvas.freeDrawingBrush.drawCircle(a)}})),canvas.on("mouse:out",(function(){canvas.freeDrawingBrush&&canvas.freeDrawingBrush.clearCircle&&canvas.freeDrawingBrush.clearCircle()})),document.getElementById("image-loader").addEventListener("change",(function(e){var a=new FileReader;a.onload=function(e){var a=new Image;a.src=e.target.result,a.onload=function(){var e=new fabric.Image(a);e.set({left:100,top:100,angle:0,padding:10,cornersize:10}),canvas.add(e)}},a.readAsDataURL(e.target.files[0])}))</script></body></html>