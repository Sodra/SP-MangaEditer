<!DOCTYPE html>
<html lang="ja">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>#cnv{position:relative;display:inline-block}#ted{position:absolute;top:0;left:0;background-color:white;color:black;caret-color:#000;font-family:"MS Mincho","ＭＳ 明朝",serif;font-size:20px;line-height:1.2;border:none;box-sizing:border-box;resize:none;overflow:hidden;writing-mode:vertical-rl;text-orientation:upright;letter-spacing:.1em;padding:5px;display:none}#ctl{margin-top:10px}#ctl label,#ctl input{margin-right:10px}</style>
</head>
<body>
<div id="cnv"><canvas id="can" width="500" height="500"></canvas><textarea id="ted"></textarea></div>
<div id="ctl">
<button id="add">新しいテキストを追加</button>
<button id="itl">イタリック切替</button>
<button id="rot">回転</button>
<br><br>
<label for="lineHeight">行間:</label>
<input type="range" id="lineHeight" min="0.1" max="3" step="0.1" value="1.2">
<span id="lineHeightValue">1.2</span>
</div>
<script>
try{const VerticalText=fabric.util.createClass(fabric.Object,{type:"verticalText",text:"",fontSize:20,fontFamily:'"MS Mincho", "ＭＳ 明朝", serif',fill:"black",padding:5,lineSpacing:1.2,letterSpacing:.1,textAlign:"center",fontWeight:"normal",fontStyle:"normal",initialize:function(t,e){e||(e={}),this.text=t||"",this.callSuper("initialize",e),this._updateDimensions()},_updateDimensions:function(){const t=this.canvas?this.canvas.getContext("2d"):fabric.util.createCanvasElement().getContext("2d");t.font=`${this.fontStyle} ${this.fontWeight} ${this.fontSize}px ${this.fontFamily}`;const e=this.text.split("\n"),i=Math.max(...e.map(t=>t.length)),n=Math.max(...this.text.split("").map(e=>t.measureText(e).width)),s=(n*(1+this.letterSpacing)+2*this.padding)*e.length,o=i*this.fontSize*this.lineSpacing+2*this.padding,a=this.left-(s-this.width);this.set({width:s,height:o,left:a});console.log("VerticalText _updateDimensions:",{oldWidth:this.width,newWidth:s,oldLeft:this.left,newLeft:a,lineCount:e.length})},_render:function(t){t.save(),t.font=`${this.fontStyle} ${this.fontWeight} ${this.fontSize}px ${this.fontFamily}`,t.fillStyle=this.fill,t.textAlign=this.textAlign,t.textBaseline="middle";const e=this.text.split("\n"),i=this.width/e.length;e.forEach((e,n)=>{const s=e.split("");let o;switch(this.textAlign){case"right":o=this.width/2-i*n;break;case"left":o=this.width/2-i*(n+1);break;default:o=this.width/2-i*(n+.5)}let a=-this.height/2+this.padding+this.fontSize/2;s.forEach((e,i)=>{t.fillText(e,o,a+i*this.fontSize*this.lineSpacing)})}),t.restore()},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"),{text:this.text,fontSize:this.fontSize,fontFamily:this.fontFamily,fontWeight:this.fontWeight,fontStyle:this.fontStyle,fill:this.fill,padding:this.padding,lineSpacing:this.lineSpacing,letterSpacing:this.letterSpacing,textAlign:this.textAlign})},_set:function(t,e){return this.callSuper("_set",t,e),("text"===t||"fontSize"===t||"fontFamily"===t||"fontWeight"===t||"fontStyle"===t||"lineSpacing"===t||"letterSpacing"===t||"textAlign"===t)&&this._updateDimensions(),this}});fabric.VerticalText=VerticalText,fabric.VerticalText.fromObject=function(t,e){return fabric.Object._fromObject("VerticalText",t,e)};const cnv=new fabric.Canvas("can"),ted=document.getElementById("ted");let avt=null;function utp(){if(!avt)return;const t=cnv.getZoom(),e=cnv.viewportTransform,i=avt,n=i.getBoundingRect(),s=n.left*t+e[4],o=n.top*t+e[5];ted.style.left=`${s}px`,ted.style.top=`${o}px`,ted.style.width=`${n.width}px`,ted.style.height=`${n.height}px`,ted.style.fontSize=`${i.fontSize*i.scaleY}px`,ted.style.letterSpacing=`${i.letterSpacing}em`,ted.style.fontWeight=i.fontWeight,ted.style.fontStyle=i.fontStyle,ted.style.fontFamily=i.fontFamily,ted.style.padding=`${i.padding}px`,ted.style.lineHeight=parseFloat(i.lineSpacing)+.2,ted.style.transform=`rotate(${i.angle}deg)`,ted.style.transformOrigin="left top";console.log("Line Height Settings:");console.log("Text Object lineSpacing:",i.lineSpacing);console.log("Text Editor lineHeight:",ted.style.lineHeight)}function stc(){if(avt){const t=ted.value.replace(/\r\n/g,"\n");console.log("Syncing text:",{oldText:avt.text,newText:t}),avt.set("text",t),avt._updateDimensions(),cnv.renderAll(),utp()}}function ste(t){avt=t,ted.value=t.text,utp(),ted.style.display="block",setTimeout(()=>ted.focus(),0)}function hte(){ted.style.display="none",avt=null}cnv.setBackgroundColor("#FFE6E6",cnv.renderAll.bind(cnv));const txt=new VerticalText("縦書き\nテキスト",{left:100,top:100,fontSize:20,fill:"black"});cnv.add(txt),ted.addEventListener("input",stc),ted.addEventListener("keydown",function(t){"Enter"===t.key&&(t.preventDefault(),document.execCommand("insertLineBreak"),stc())}),ted.onblur=hte,cnv.on("object:moving",utp),cnv.on("object:scaling",utp),cnv.on("object:rotating",utp),cnv.on("zoom:changed",utp),cnv.on("viewportTransform",utp),cnv.on("mouse:down",function(t){t.target&&t.target instanceof VerticalText?(cnv.setActiveObject(t.target),cnv.renderAll()):hte()}),cnv.on("mouse:dblclick",function(t){t.target&&t.target instanceof VerticalText&&ste(t.target)}),document.getElementById("add").addEventListener("click",function(){const t=new VerticalText("新しいテキスト",{left:Math.random()*(cnv.width-100),top:Math.random()*(cnv.height-100),fontSize:20,fill:"black"});cnv.add(t),cnv.renderAll()}),document.getElementById("itl").addEventListener("click",function(){avt&&(avt.set("fontStyle",avt.fontStyle==="italic"?"normal":"italic"),cnv.renderAll(),utp())}),document.getElementById("rot").addEventListener("click",function(){avt&&(avt.rotate(avt.angle+15),cnv.renderAll(),utp())});const lineHeightSlider=document.getElementById("lineHeight"),lineHeightValue=document.getElementById("lineHeightValue");lineHeightSlider.addEventListener("input",function(){const t=parseFloat(this.value);lineHeightValue.textContent=t.toFixed(1),avt&&(avt.set("lineSpacing",t),ted.style.lineHeight=t+.2,avt._updateDimensions(),cnv.renderAll(),utp())}),cnv.renderAll()}catch(e){console.error("Global error caught:",e)}
</script>
</body>
</html>
